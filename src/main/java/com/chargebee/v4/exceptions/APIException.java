/*
 * This file is auto-generated by Chargebee.
 * Copyright 2025 Chargebee Inc.
 */

package com.chargebee.v4.exceptions;

import com.chargebee.v4.exceptions.codes.ApiErrorCode;
import com.chargebee.v4.internal.JsonUtil;
import com.chargebee.v4.transport.Request;
import com.chargebee.v4.transport.Response;

import java.util.ArrayList;
import java.util.List;

/**
 * Base exception for all Chargebee API errors.
 *
 * <p>Contains parsed error information from the API response with the following attributes:
 *
 * <ul>
 *   <li><b>message</b> - Descriptive information about the error (for developer consumption)
 *   <li><b>type</b> - Groups errors based on error handling routine (payment, invalid_request,
 *       operation_failed)
 *   <li><b>api_error_code</b> - Specific code for handling specific errors
 *   <li><b>param</b> - The parameter name if error is due to a specific parameter
 *   <li><b>error_cause_id</b> - Chargebee-defined code for standardizing errors across gateway
 *       services
 * </ul>
 *
 * <p>Use {@link #getErrorType()} for strongly-typed error type handling.
 *
 * <p>Example usage:
 *
 * <pre>{@code
 * try {
 *     // API call
 * } catch (InvalidRequestException e) {
 *     ErrorType type = e.getErrorType();
 *     ApiErrorCode errorCode = e.getApiErrorCode();
 *     List<String> invalidParams = e.getParams();
 *     String causeId = e.getErrorCauseId();
 *
 *     // Type-safe error handling with enum
 *     if (errorCode instanceof BadRequestApiErrorCode) {
 *         BadRequestApiErrorCode code = (BadRequestApiErrorCode) errorCode;
 *         if (code == BadRequestApiErrorCode.DUPLICATE_ENTRY) {
 *             // Handle duplicate entry
 *         }
 *     }
 * } catch (PaymentException e) {
 *     // Check error_cause_id for gateway-specific error handling
 *     if (e.getErrorCauseId() != null) {
 *         System.out.println("Gateway error cause: " + e.getErrorCauseId());
 *     }
 * }
 * }</pre>
 */
public class APIException extends HttpException {

  /**
   * The error type as a strongly-typed enum. Groups errors based on the error handling routine
   * required.
   */
  private final ErrorType errorType;

  /**
   * The raw error type string as returned by the API. Values: "payment", "invalid_request",
   * "operation_failed", or null.
   */
  private final String type;

  /**
   * A more specific error code as a strongly-typed enum. Implements ApiErrorCode interface for
   * type-safe error handling.
   */
  private final ApiErrorCode apiErrorCode;

  /**
   * The raw API error code string as returned by the API. Example: "duplicate_entry",
   * "payment_processing_failed", "resource_not_found"
   */
  private final String apiErrorCodeRaw;

  /**
   * The parameter name(s) if the error is due to specific parameter(s). Empty list if error is not
   * parameter-specific.
   */
  private final List<String> params;

  /**
   * Chargebee-defined code for standardizing errors across different gateway services. Helps in
   * consistent error handling across payment gateways. May be null if not applicable.
   */
  private final String errorCauseId;

  /** The full JSON response for debugging or extracting additional details. */
  private final String jsonResponse;

  public APIException(
      int statusCode,
      String type,
      ApiErrorCode apiErrorCode,
      String message,
      String jsonResponse,
      Request request,
      Response response) {
    super(statusCode, message, request, response);
    this.type = type;
    this.errorType = ErrorType.fromString(type);
    this.apiErrorCode = apiErrorCode;
    this.apiErrorCodeRaw = apiErrorCode != null ? apiErrorCode.getValue() : null;
    this.jsonResponse = jsonResponse;
    this.params = extractParams(jsonResponse);
    this.errorCauseId = extractErrorCauseId(jsonResponse);
  }

  /**
   * Get the error type as a strongly-typed enum. Use this for programmatic error handling with type
   * safety.
   *
   * <p>The type groups errors based on the error handling routine required:
   *
   * <ul>
   *   <li>{@link ErrorType#PAYMENT} - Payment-related errors
   *   <li>{@link ErrorType#INVALID_REQUEST} - Validation and request errors
   *   <li>{@link ErrorType#OPERATION_FAILED} - Business logic errors
   * </ul>
   *
   * @return the error type enum, or {@link ErrorType#_UNKNOWN} for unrecognized types
   */
  public ErrorType getErrorType() {
    return errorType;
  }

  /**
   * Get the raw error type string as returned by the API. Use this when you need the exact API
   * value or for logging.
   *
   * <p>Possible values: "payment", "invalid_request", "operation_failed", or null
   *
   * @return the raw error type string, may be null
   */
  public String getType() {
    return type;
  }

  /**
   * Get the API error code as a strongly-typed enum.
   *
   * <p>The returned enum implements {@link ApiErrorCode} and can be cast to the specific enum type
   * based on the HTTP status code:
   *
   * <pre>{@code
   * ApiErrorCode code = e.getApiErrorCode();
   * if (code instanceof BadRequestApiErrorCode) {
   *     BadRequestApiErrorCode badRequestCode = (BadRequestApiErrorCode) code;
   *     if (badRequestCode == BadRequestApiErrorCode.DUPLICATE_ENTRY) {
   *         // Handle duplicate
   *     }
   * }
   * }</pre>
   *
   * @return the API error code as a typed enum
   */
  public ApiErrorCode getApiErrorCode() {
    return apiErrorCode;
  }

  /**
   * Get the raw API error code string as returned by the API. Use this when you need the exact API
   * value or for logging.
   *
   * @return the raw API error code string
   */
  public String getApiErrorCodeRaw() {
    return apiErrorCodeRaw;
  }

  /**
   * Get the parameter name(s) that caused the error.
   *
   * <p>This is provided when the error is due to a specific parameter. The parameter name matches
   * the API documentation (cURL format).
   *
   * <p>Note: For URL path parameters like customer_id, if invalid, a resource_not_found error is
   * thrown without the param attribute.
   *
   * @return list of parameter names that caused the error, empty if not parameter-specific
   */
  public List<String> getParams() {
    return params;
  }

  /**
   * Get the first parameter name that caused the error. Convenience method when only one parameter
   * is expected.
   *
   * @return the first parameter name, or null if no parameters
   */
  public String getParam() {
    return params.isEmpty() ? null : params.get(0);
  }

  /**
   * Get the error cause ID - a Chargebee-defined code for standardizing errors across different
   * gateway services.
   *
   * <p>This helps in identifying and handling errors consistently across different payment
   * gateways.
   *
   * @return the error cause ID, may be null if not applicable
   */
  public String getErrorCauseId() {
    return errorCauseId;
  }

  /**
   * Get the full JSON response as string. Useful for debugging or extracting additional error
   * details not covered by the typed fields.
   *
   * @return the full JSON error response
   */
  public String getJsonResponse() {
    return jsonResponse;
  }

  /** Extract parameter names from error response. */
  private List<String> extractParams(String jsonResponse) {
    List<String> paramsList = new ArrayList<>();
    if (jsonResponse != null) {
      String param = JsonUtil.getString(jsonResponse, "param");
      if (param != null) {
        paramsList.add(param);
      } else {
        String paramArray = JsonUtil.getArray(jsonResponse, "param");
        if (paramArray != null) {
          paramsList.addAll(JsonUtil.parseArrayOfString(paramArray));
        }
      }
    }
    return paramsList;
  }

  /** Extract error_cause_id from error response. */
  private String extractErrorCauseId(String jsonResponse) {
    if (jsonResponse != null) {
      return JsonUtil.getString(jsonResponse, "error_cause_id");
    }
    return null;
  }

  /**
   * API errors are generally not retryable as they indicate business logic issues.
   * 
   * <p>Exceptions that may warrant retry:
   * <ul>
   *   <li>429 Too Many Requests - Rate limiting</li>
   *   <li>5xx Server errors - Temporary server issues</li>
   * </ul>
   *
   * @return true only for 429 or 5xx status codes
   */
  @Override
  public boolean isRetryable() {
    int code = getStatusCode();
    // 429 Too Many Requests or 5xx server errors (except 501)
    return code == 429 || (code >= 500 && code != 501);
  }

  @Override
  public String toString() {
    StringBuilder sb = new StringBuilder();
    sb.append(getClass().getSimpleName());
    sb.append("{statusCode=").append(getStatusCode());
    if (type != null) {
      sb.append(", type='").append(type).append("'");
    }
    if (apiErrorCodeRaw != null) {
      sb.append(", apiErrorCode='").append(apiErrorCodeRaw).append("'");
    }
    sb.append(", message='").append(getMessage()).append("'");
    if (params != null && !params.isEmpty()) {
      sb.append(", params=").append(params);
    }
    if (errorCauseId != null) {
      sb.append(", errorCauseId='").append(errorCauseId).append("'");
    }
    sb.append("}");
    return sb.toString();
  }
}
